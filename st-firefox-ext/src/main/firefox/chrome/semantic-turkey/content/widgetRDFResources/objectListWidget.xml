<?xml version="1.0"?>
<bindings xmlns="http://www.mozilla.org/xbl"
	xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
	<binding id="object-list-widget">
		<content>
			<xul:vbox anonid="externalOWLid" flex="1"  >
				<xul:label anonid="labelId"/>
				<xul:hbox anonid="buttonBoxOLW" />
				<xul:vbox anonid="mainOLWboxId" style='overflow: auto;' />
			</xul:vbox>
		</content>
		<implementation>
			<field name="operations" />
			<field name="labelValue" />
			<field name="rdfResourcesArray" />
			<field name="rdfPredicate" />
			<field name="hasCustomRange" />
			<field name="addRemoveButton" />
			<field name="forceList" />
			
			<constructor>
				<![CDATA[
					const OBJECT_COUNT_TRESHOLD = 5;
					const MAXHEIGHT_VALUE = 200;
					
					if (typeof art_semanticturkey == 'undefined')
					var art_semanticturkey = {};
					Components.utils.import("resource://stmodules/StResUtils.jsm", art_semanticturkey);
					Components.utils.import("resource://stmodules/Logger.jsm", art_semanticturkey);
					Components.utils.import("resource://stmodules/ARTResources.jsm", art_semanticturkey);
					
					var label = document.getAnonymousElementByAttribute(this, "anonid", "labelId");
					var maindOLWbox = document.getAnonymousElementByAttribute(this, "anonid", "mainOLWboxId");
					
					maindOLWbox.setAttribute("maxheight", MAXHEIGHT_VALUE);
					
					var externalOWLid = document.getAnonymousElementByAttribute(this, "anonid", "externalOWLid");
					externalOWLid.setAttribute("maxheight", MAXHEIGHT_VALUE+20);
					
					if(typeof this.labelValue != "undefined"){
						label.setAttribute("value", this.labelValue);
						label.setAttribute("flex", "1");
					}
					
					
					if(typeof this.rdfResourcesArray != "undefined"){
						maindOLWbox.setAttribute("flex", "1");
						if(this.rdfResourcesArray.length >= OBJECT_COUNT_TRESHOLD || (typeof this.forceList != "undefined" && this.forceList == true)){
							//create the buttons
							if(typeof this.addRemoveButton == "undefined" || this.addRemoveButton == true ){
							var button = document.createElement("button");
							button.setAttribute("label", "remove");
							document.getAnonymousElementByAttribute(this, "anonid", "buttonBoxOLW")
									.appendChild(button);
							}
							
							//add the resources list
							var richListBox = document.createElement("richlistbox");
							for (var i = 0; i < this.rdfResourcesArray.length; i++) {
								var rdfRes = rdfResourcesArray[i];
								
								var richListItem = document.createElement("richlistitem");
								richListItem.setAttribute("flex", "1");
								
								var widgetBox = document.createElement("box");
								widgetBox.setAttribute("flex", "1");
								richListItem.appendChild(widgetBox);
								richListBox.appendChild(richListItem);
								widgetBox.rdfResource = rdfRes;
								if (typeof this.rdfPredicate != "undefined" && 
										this.hasCustomRange == "true" &&
										(rdfRes instanceof art_semanticturkey.ARTURIResource ||
										rdfRes instanceof art_semanticturkey.ARTBNode)){
									widgetBox.rdfPredicate = this.rdfPredicate;
									widgetBox.setAttribute("class","reifiable-object-widget");
								} else { //rdfRes instanceof art_semanticturkey.ARTLiteral
									widgetBox.setAttribute("class","rdfnode-base-widget");
								}
							}
							maindOLWbox.appendChild(richListBox);
						
						} else{ // this.rdfResourcesArray.lentgh < OBJECT_COUNT_TRESHOLD
							for (var i = 0; i < this.rdfResourcesArray.length; i++) {
								var rdfRes = rdfResourcesArray[i];
								
								var widgetBox = document.createElement("box");
								widgetBox.setAttribute("flex", "1");
								maindOLWbox.appendChild(widgetBox);
								
								widgetBox.rdfResource = rdfRes;
								//TODO check if it is correct to have just the remove button
								widgetBox.operations = this.operations;
								widgetBox.rdfPredicate = this.rdfPredicate;
								widgetBox.hasCustomRange = this.hasCustomRange;
								widgetBox.setAttribute("class","rdfnode-container-widget");
							}
						}
					}
				]]>
			</constructor>
			<method name="getObjectsArray">
				<body>
				<![CDATA[
					return this.rdfResourcesArray;
				]]>
				</body>
			</method>
			<method name="getSelectedRDFResource">
				<body>
				<![CDATA[
					var richlistbox =  document.getAnonymousElementByAttribute(this, "anonid", 
								"mainOLWboxId").getElementsByTagName("richlistbox")[0];
				
					if(typeof this.rdfResourcesArray == "undefined" || richlistbox == null)
						return null;
					var richListItem = richlistbox.selectedItem;
					var selectedBox = richListItem.getElementsByTagName("box")[0];
					return selectedBox.rdfResource;
				]]>
				</body>
			</method>
		</implementation>
		<handlers>
			<handler event="dblclick">
				<![CDATA[
					/*alert("object-list-widget: event.test = "+event.test);
				
					alert("object-list-widget : double click event happeneds ");
					var target = event.target;
					alert("tag name = "+target.tagName+"\nclass = "+target.getAttribute("class"));*/
	     		]]>
			</handler>
			<handler event="command">
				<![CDATA[
					if(event.originalTarget.tagName == "button" && 
							event.originalTarget.getAttribute("label") == "remove"){
						
						var richlistbox =  document.getAnonymousElementByAttribute(this, "anonid", 
								"mainOLWboxId").getElementsByTagName("richlistbox")[0];
						var richListItem = richlistbox.selectedItem;
						var selectedBox = richListItem.getElementsByTagName("box")[0];
						
						var customEvent = new CustomEvent("objectListEvent", {
							detail: {
								rdfResource: selectedBox.rdfResource,
								button: event.originalTarget
							},
							bubble: true,
							cancellable: true
						})
						event.originalTarget.dispatchEvent(customEvent);
					}
				]]>
			</handler>
		</handlers>
	</binding>
</bindings>